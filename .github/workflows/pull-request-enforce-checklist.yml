name: Enforce PR Checklist

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate PR checklist
        id: checklist
        run: |
          # Load PR description into a variable
          pr_body=$(jq -r .pull_request.body "$GITHUB_EVENT_PATH")

          # Define required checkboxes
          changelog_checkbox="- \[x\] This PR doesn't need to update changelog"
          unit_test_checkbox="- \[x\] I have either added unit tests for this feature or confirmed it doesn't need unit tests"
          environment_checkbox="- \[x\] I have tested this feature in an environment (e.g., production, development, local)"

          # Check each box
          if ! echo "$pr_body" | grep -q "$changelog_checkbox"; then
            echo "::error ::Please check the box to indicate if this PR doesn't need to update changelog."
            changelog_needed=true
          fi

          if ! echo "$pr_body" | grep -q "$unit_test_checkbox"; then
            echo "::error ::Please check the box to confirm if unit tests were added or if they're not needed."
            exit 1
          fi

          if ! echo "$pr_body" | grep -q "$environment_checkbox"; then
            echo "::error ::Please check the box to confirm the feature was tested in an environment."
            exit 1
          fi

          # If changelog box is unchecked, check if changelog.md was modified
          if [ "$changelog_needed" = true ] && ! git diff --name-only origin/main | grep -q "changelog.md"; then
            echo "::error ::Changelog entry required. Please add a change in changelog.md or check the box."
            exit 1
          fi